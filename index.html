<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HTML Cleaner — Custom Script</title>
  <style>
    body{font-family:sans-serif;display:flex;flex-direction:column;align-items:center;gap:16px;padding:20px;background:#f6f7fb}
    .drop{width:720px;min-height:160px;border:3px dashed #bbb;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#fff;cursor:pointer}
    .drop.drag{border-color:#6a9bff;box-shadow:0 0 12px rgba(106,155,255,0.2)}
    textarea{width:720px;height:260px;font-family:monospace;font-size:13px;border-radius:8px;border:1px solid #ccc;padding:8px}
    .controls{display:flex;gap:8px}
    button{padding:8px 14px;border:1px solid #aaa;border-radius:8px;background:#fff;cursor:pointer}
    .log{width:720px;max-height:200px;overflow:auto;background:#fff;padding:8px;border-radius:8px;border:1px solid #ddd;font-family:monospace;font-size:13px}
    .small{font-size:13px;color:#666}
  </style>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <h2>HTML Cleaner with Custom Script</h2>

  <div class="drop" id="drop">Drop .html files or click to select</div>

  <div class="controls">
    <input id="fileInput" type="file" accept=".html,.htm" multiple style="display:none">
    <button id="selectBtn">Select files</button>
    <button id="processBtn">Process & Download ZIP</button>
    <span class="small" id="count">0 files queued</span>
  </div>

  <textarea id="scriptArea"></textarea>
  <div class="log" id="log"></div>

<script>
// --- default script: your cleaning code
const defaultScript = `
(function ($container) {
  // { ... } → h3
  $container.find('p').each(function(){
    const t = $(this).text().trim();
    if (/^\\{.*\\}$/.test(t)) {
      $('<h3/>').text(t.replace(/^\\{|\\}$/g,'').trim()).replaceAll(this);
    }
  });

  // p starting with "Глава" → h2
  $container.find('p').each(function(){
    const t = $(this).text().trim();
    if (/^Глава/.test(t)) {
      const $h2 = $('<h2/>').html($(this).html());
      $(this).replaceWith($h2);
    }
  });

  // wrap numbers
  function wrapNumbersNode(node){
    if(node.nodeType === 3){
      const v = node.nodeValue;
      if(/\\d+/.test(v)) {
        const tmp = document.createElement('span');
        tmp.innerHTML = v.replace(/(\\d+)/g,'<span class="nmbr">$1</span>');
        $(node).replaceWith($(tmp).contents());
      }
    } else if(node.nodeType === 1) {
      if (['SCRIPT','STYLE','CODE','PRE','NOSCRIPT'].includes(node.tagName)) return;
      $(node).contents().each((_,c)=>wrapNumbersNode(c));
    }
  }
  $container.contents().each((_,c)=>wrapNumbersNode(c));

  // fix img src prefix
  $container.find('img').each(function(){
    const src = $(this).attr('src') || '';
    const filename = (src.split(/[?#]/)[0].split('/').pop()||'').toLowerCase();
    let type = 'D';
    if(/\\.gif$/i.test(filename)) type = 'A';
    else if(/^img_/i.test(filename)) type = 'B';
    else if(/\\.png$/i.test(filename)) type = 'C';
    $(this).attr('src', './assets/img/' + type + '/' + src);
  });

  // split into chapters
  const containerChildren = $container.contents().toArray();
  const wrapper = $('<div id="text" class="text1"></div>');
  let chapterIndex = -1;
  let $chapter = null;
  containerChildren.forEach(node => {
    if(node.nodeType === 1 && node.tagName === 'H2' && /^Глава/.test($(node).text().trim())){
      chapterIndex++;
      $chapter = $('<div/>',{class:'text chapter' + chapterIndex}).append('<span id="start"></span>');
      wrapper.append($chapter);
      $chapter.append(node);
    } else {
      if($chapter) $chapter.append(node);
      else wrapper.append(node);
    }
  });
  wrapper.find('div.text').append('<span id="end"></span>');
  return wrapper.prop('outerHTML');
})
`.trim();

$('#scriptArea').val(defaultScript);

let files=[];

function logMsg(...t){ $('#log').append(t.join(' ')+'<br>').scrollTop($('#log')[0].scrollHeight); }

$('#selectBtn').on('click',()=>$('#fileInput').click());
$('#fileInput').on('change',e=>{
  addFiles([...e.target.files]); e.target.value='';
});

$('#drop').on('click',()=>$('#fileInput').click())
.on('dragenter dragover',e=>{e.preventDefault();$('#drop').addClass('drag');})
.on('dragleave drop',e=>{e.preventDefault();$('#drop').removeClass('drag');})
.on('drop',e=>{addFiles([...e.originalEvent.dataTransfer.files]);});

function addFiles(list){
  list.forEach(f=>{
    if(/\\.html?$/i.test(f.name)){ files.push(f); logMsg('Queued:',f.name);}
    else logMsg('Skipped:',f.name);
  });
  $('#count').text(files.length+' files queued');
}

function getUserFunction(src){
  src = src.replace(/;+\s*$/, ''); // strip trailing semicolons
  try {
    const fn = new Function('return (' + src + ')')();
    if (typeof fn !== 'function') throw new Error('Script did not evaluate to a function');
    return fn;
  }catch(err){
    throw new Error('Invalid script: ' + (err && err.message ? err.message : String(err)));
  }
}

$('#processBtn').on('click',async()=>{
  if(!files.length){logMsg('No files queued');return;}
  $('#processBtn').prop('disabled',true);
  const zip=new JSZip();
  const src=$('#scriptArea').val();
  let fn;
  try{ fn=getUserFunction(src); }
  catch(err){ logMsg('Error evaluating script:',err.message); $('#processBtn').prop('disabled',false); return; }

  logMsg('Processing',files.length,'files...');
  for(const f of files){
    try{
      const txt=await f.text();
      const parser=new DOMParser();
      const doc=parser.parseFromString(txt,'text/html');
      doc.querySelectorAll('head,meta,style').forEach(e=>e.remove());
      const raw=(doc.body&&doc.body.innerHTML)||'';
      const $container=$('<div/>').html(raw);
      const out=fn($container);
      const name=f.name.replace(/\\.(html?|htm)$/i,'')+'.html';
      zip.file(name,out);
      logMsg('Processed:',f.name);
    }catch(err){logMsg('Error:',f.name,err.message);}
  }
  const blob=await zip.generateAsync({type:'blob'});
  saveAs(blob,'cleaned_html.zip');
  logMsg('ZIP ready');
  files=[];$('#count').text('0 files queued');
  $('#processBtn').prop('disabled',false);
});
</script>
</body>
</html>
